<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像SVG変換ツール</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>画像SVG変換ツール</h1>
            <p>JPG、PNG、GIF、WebP画像をSVG形式に変換します</p>
        </header>

        <main>
            <div class="upload-container" id="upload-container">
                <div class="upload-area" id="upload-area">
                    <p>画像をここにドラッグ&ドロップ</p>
                    <p>または</p>
                    <label for="file-input" class="upload-button">画像を選択</label>
                    <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif,image/webp,image/*" hidden>
                </div>
            </div>

            <div class="settings-container" id="settings-container" style="display: none;">
                <h3>変換設定</h3>
                <div class="settings-group threshold-container">
                    <label for="threshold-range">閾値: <span id="threshold-value">128</span></label>
                    <input type="range" id="threshold-range" min="1" max="255" value="128">
                    <div class="settings-description">閾値は白黒変換時の明暗の境界値を決定します</div>
                </div>
                <div class="settings-group">
                    <label for="color-mode">カラーモード:</label>
                    <select id="color-mode">
                        <option value="color">カラー</option>
                        <option value="bw">白黒</option>
                    </select>
                    <div class="settings-description">カラーモードは変換結果の色表現を決定します</div>
                </div>
                <div class="settings-group">
                    <label for="simplify-range">単純化: <span id="simplify-value">0.5</span></label>
                    <input type="range" id="simplify-range" min="0" max="1" step="0.1" value="0.5">
                    <div class="settings-description">単純化はSVGパスの複雑さを調整します（値が大きいほど単純）</div>
                </div>
                <div class="settings-group color-quantization-container">
                    <label for="color-quantization-range">色の数: <span id="color-quantization-value">16</span></label>
                    <input type="range" id="color-quantization-range" min="2" max="64" value="16">
                    <div class="settings-description">カラーモード時の最大色数を制限します（少ないほどファイルサイズが小さく）</div>
                </div>
                <div class="settings-group">
                    <label for="blur-radius-range">ブラー: <span id="blur-radius-value">0</span></label>
                    <input type="range" id="blur-radius-range" min="0" max="5" step="0.1" value="0">
                    <div class="settings-description">変換前にブラーをかけてノイズを減らします</div>
                </div>
                <div class="settings-group stroke-width-container">
                    <label for="stroke-width-range">ストローク幅: <span id="stroke-width-value">0</span></label>
                    <input type="range" id="stroke-width-range" min="0" max="5" step="0.1" value="0">
                    <div class="settings-description">白黒モード時のパスの線幅を設定します（0は塗りつぶし）</div>
                </div>
            </div>

            <div class="preview-container" id="preview-container" style="display: none;">
                <div class="preview-section">
                    <h3>元の画像</h3>
                    <div class="image-preview">
                        <img id="original-image" src="" alt="元の画像">
                    </div>
                </div>
                
                <div class="preview-section">
                    <h3>SVG変換プレビュー</h3>
                    <div class="svg-preview" id="svg-preview">
                        <!-- SVGがここに表示されます -->
                    </div>
                </div>
            </div>

            <div class="progress-container" id="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                <p id="progress-text">変換中... 0%</p>
            </div>

            <div class="control-panel" id="control-panel" style="display: none;">
                <button id="convert-btn" class="convert-button">変換実行</button>
                <button id="download-btn" class="download-button">SVGをダウンロード</button>
                <button id="reset-btn" class="reset-button">リセット</button>
                <details>
                    <summary>SVGコード</summary>
                    <pre id="svg-code" class="svg-code"></pre>
                </details>
            </div>
        </main>

        <footer>
            <p>© 2025 画像SVG変換ツール - プライバシーを考慮した完全クライアントサイド処理</p>
        </footer>
    </div>

    <!-- Potraceライブラリ -->
    <script>
        // Potraceライブラリの読み込み状態を確認するためのフラグ
        window.potraceLoaded = false;
        
        // Potraceライブラリの読み込み試行回数
        let potraceLoadAttempts = 0;
        const maxPotraceLoadAttempts = 3;
        
        // Potraceライブラリの読み込みが成功した場合の処理
        function potraceLoadSuccess() {
            console.log('Potraceライブラリの読み込みが成功しました');
            window.potraceLoaded = true;
        }
        
        // Potraceライブラリの読み込みが失敗した場合の処理
        function potraceLoadError() {
            potraceLoadAttempts++;
            console.warn(`Potraceライブラリの読み込みに失敗しました (${potraceLoadAttempts}/${maxPotraceLoadAttempts})。`);
            
            if (potraceLoadAttempts < maxPotraceLoadAttempts) {
                // 別のCDNソースから再試行
                console.log('別のソースからPotraceライブラリを読み込み直します...');
                setTimeout(loadPotraceLibrary, 1000);
            } else {
                console.warn('Potraceライブラリの読み込みを諦めました。代替処理が使用されます。');
            }
        }
        
        // Potraceライブラリの読み込み関数
        function loadPotraceLibrary() {
            const sources = [
                'https://cdn.jsdelivr.net/npm/potrace@2.1.8/potrace.min.js',
                'https://unpkg.com/potrace@2.1.8/potrace.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/potrace/2.1.8/potrace.min.js'
            ];
            
            const script = document.createElement('script');
            script.src = sources[potraceLoadAttempts % sources.length];
            script.onload = potraceLoadSuccess;
            script.onerror = potraceLoadError;
            document.body.appendChild(script);
        }
        
        // 初回読み込み
        loadPotraceLibrary();
    </script>
    <script src="imagetracer.js"></script>
    <script src="app.js"></script>
</body>
</html>
